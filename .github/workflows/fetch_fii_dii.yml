name: "FII/DII Daily Data Sync"

on:
  schedule:
    - cron: '0 13 * * *'   # Daily at 13:00 UTC (~6:30 PM IST)
  workflow_dispatch:

concurrency:
  group: update-fii-dii-data
  cancel-in-progress: true

permissions:
  contents: write
  actions: write

# --------------------------------------------------------------
# 1. Guard – skip weekends (Sat = 6, Sun = 0)
# --------------------------------------------------------------
jobs:
  check-weekend:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Check day of week
        id: check
        run: |
          DOW=$(date -u '+%w')   # 0=Sun, 1=Mon, ..., 6=Sat
          if [[ $DOW -eq 0 || $DOW -eq 6 ]]; then
            echo "Skipping – today is a weekend."
            echo "should_run=false" >> $GITHUB_OUTPUT
          else
            echo "Today is a weekday – proceeding."
            echo "should_run=true" >> $GITHUB_OUTPUT
          fi

  # --------------------------------------------------------------
  # 2. Original job – only runs on weekdays
  # --------------------------------------------------------------
  fetch-and-update:
    needs: check-weekend
    if: ${{ needs.check-weekend.outputs.should_run == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install requests beautifulsoup4

      - name: Clean old data files (keep today & yesterday)
        run: |
          echo "Cleaning old FII/DII JSON files..."
          TODAY=$(date -u +"%Y-%m-%d")
          YESTERDAY=$(date -u -d "yesterday" +"%Y-%m-%d")
          KEEP_PATTERN="fii_dii_data_(${TODAY}|${YESTERDAY}).json"
          shopt -s nullglob
          for file in fii_dii_data_*.json; do
            if [[ "$file" =~ $KEEP_PATTERN ]]; then
              echo "Keeping: $file"
            else
              echo "Removing old: $file"
              rm -f "$file"
            fi
          done
          shopt -u nullglob

      - name: Fetch latest FII/DII data
        id: fetch
        run: |
          python fetch_fii_dii_daily.py
          TODAY_FILE="fii_dii_data_$(date -u +'%Y-%m-%d').json"
          if [ ! -f "$TODAY_FILE" ]; then
            echo "::error::Failed to generate $TODAY_FILE"
            exit 1
          fi
          echo "Data fetched: $TODAY_FILE"

      - name: Update main and previous files
        run: |
          TODAY=$(date -u +"%Y-%m-%d")
          YESTERDAY=$(date -u -d "yesterday" +"%Y-%m-%d")
          cp -f "fii_dii_data_${TODAY}.json" fii_dii_data.json
          echo "Updated fii_dii_data.json"
          if [ -f "fii_dii_data_${YESTERDAY}.json" ]; then
            cp -f "fii_dii_data_${YESTERDAY}.json" fii_dii_data_prev.json
            echo "Updated fii_dii_data_prev.json"
          else
            cp -f fii_dii_data.json fii_dii_data_prev.json
            echo "Warning: Yesterday's data missing. Using today as previous."
          fi

      - name: Commit and push changes
        run: |
          git config --global user.name "FII/DII Data Bot"
          git config --global user.email "fii-dii-bot@users.noreply.github.com"
          git fetch origin main
          git checkout main
          git reset --hard origin/main
          git add fii_dii_data*.json
          if git diff --staged --quiet; then
            echo "No changes. Skipping commit."
            exit 0
          fi
          git commit -m "FII/DII Update – $(date +'%b %d, %Y')"
          git push origin main
          echo "Pushed latest FII/DII data"

      - name: Cleanup old workflow runs (keep last 2)
        if: always()
        run: |
          echo "Cleaning old workflow runs..."
          WORKFLOW_FILE=".github/workflows/fetch_fii_dii.yml"
          WORKFLOW_ID=$(gh api "repos/${{ github.repository }}/actions/workflows" \
            --jq ".workflows[] | select(.path == \"$WORKFLOW_FILE\") | .id")
          [ -z "$WORKFLOW_ID" ] && { echo "Workflow not found."; exit 0; }
          gh api "repos/${{ github.repository }}/actions/workflows/$WORKFLOW_ID/runs" \
            --paginate \
            --jq '.workflow_runs[].id' | head -n 100 | tail -n +3 > old_runs.txt
          [ ! -s old_runs.txt ] && { echo "No old runs to delete."; rm -f old_runs.txt; exit 0; }
          echo "Deleting $(wc -l < old_runs.txt) old run(s)..."
          while read -r run_id; do
            gh api "repos/${{ github.repository }}/actions/runs/$run_id" -X DELETE || true
          done < old_runs.txt
          rm -f old_runs.txt
          echo "Cleanup complete!"
        env:
          GH_TOKEN: ${{ github.token }}
